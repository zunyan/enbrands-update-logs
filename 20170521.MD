# 2017-5-21 日记
1、2017-5-20日上午，淘宝APP内会员端白屏，白屏原因是因为2017-5-20凌晨代码修复所致，新的代码对就有逻辑进行了调整，导致会员段在淘宝内报错（微信端没有此问题），经过代码回滚，重新修改，再次上线后解决。

2、2017-5-20日下午，收到反映，美即第三个tab也显示不正常，经过测试，是淘宝APP对页面的加载机制影响了页面的访问（重复触发了reload时间，导致缓存机制被重复执行），经过修改后，已经完成。

上面两个问题，都是新代码引起的bug，此外旧代码中也有问题，只是没暴露出来而已，在修复后目前并没有发现新的状况。
在2017-5-21日凌晨，又更新了部分代码，并在中午的时候解决了邓总第三个tab页404的问题。

## 此次修改，更新了如下细节
1. 增加兑换页面积分不足时的引导操作
2. 增加【我的兑换页面】，【interactionList模块】数据加载的动画，原本无动画，让人很容易以为系统卡住了
3. 增加了【globalnav】组件的路由缓存机制，切换导航菜单时，如果本地有缓存将不会发起新的HTTP请求，而是直接使用缓存，缓存时间时30分钟，如果用户在当前页面直接刷新，则缓存会被重置
4. 调整了render代码，对出现404异常的地方加了提示处理
5. 优化了banner等相关模块，图片加载时的线框，现在，将不会看到线框
6. 对部分无法装修的页面做静态化。<i>目前只完成了兑换页面。慢慢增加</i>
7. 调整了OSS端的缓存机制，静态文件的过期时间改为两分钟（原本用户每次访问必须再次请求询问是否修改），两分钟内，静态文件不会发出新的HTTP请求

附（静态与动态对比）
![](http://enbrands-2.oss-cn-shanghai.aliyuncs.com/P3.png)
![](http://enbrands-2.oss-cn-shanghai.aliyuncs.com/P1.png)
![](http://enbrands-2.oss-cn-shanghai.aliyuncs.com/P2.png)

<b>在压测时，可以发现接口响应时间都上去了，但是静态化的页面的响应速度却依然很快，效果明显。</b>

前端静态化后会出现一些问题，比如商家修改了积分别名，但是会员段受缓存控制，需要请求非静态文件才能刷新数据。目前看来这些影响只有在商家修改设置后才出现，并切出现后在跳入其他页面后便能解决问题。

可被商家装修的页面使用静态文件的方式需要进行一定的代码调整，可以先考虑用客户端缓存的方案，较少用户的调用，只需设置http头的cache-control即可

    set http header Cache-control:max-age=120

设置每个页面的过期时间时2分钟（或是更久），在两分钟内，用户访问页面将会从缓存中获取（除直接刷新），可以减少大量的用户请求，较少服务器压力。

具体的静态化方案，还得再共同讨论研究。
