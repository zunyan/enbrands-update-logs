# 美即421活动故障总结 - 前端角度

美即官方旗舰店与2017年4月21日20点，在微信端上线了100积分+0.01元换购淘礼品（1000份，无门槛）活动，活动上线后系统即处于无法访问状态（页面5xx错误），受此影响，所有的enbrands会员中心都访问不了，enbrands后台也无法进入，知道2017年4月22日0点，会员中心才基本回复正常的访问速度，警报解除。

下面是事件节点

2017 4 21
- 20:07:29 - 美即人员(邓妙韵)在美即群内反应会员中心访问异常
- 20:08:30 - 前端接入检查问题
- 前端发现enbrands系统也进不去，由于会员端的页面数据存于后台，在渲染页面是也需要查询数据库，初步断定问题出在enbrands后台，超时导致移动端报504
- 各端负责人紧张排查问题。
- 20:49:16 - 统计信息显示，从20点开始，QPS,PV直线上升，会员端压力过大。<br>
![Alt text](http://enbrands-2.oss-cn-shanghai.aliyuncs.com/pv-qps.png)
- 20:58:30 - 服务器重启完成
- 20:58:47 - java反馈 数据库连不上
- 21:01:24 - 会员端重启
- 21:11:56 - 重启不能解决问题，开发人员反应数据库读数据很慢
- 22:05:06 -柏总提出
 1. 为什么负载不高，却响应不快？
 2. 为什么本地响应快，外部响应不快？
 3. EWS服务器能登陆进去吗？能否测试EWS服务器到S1的访问阻塞情况？确定原因？

- 多端调用s1.enbrands.com/apis/info接口（传入已经登陆的cookies)，有数据输出，但是反应很慢，30S甚至更多都没接收完
<br>![Alt text](http://enbrands-2.oss-cn-shanghai.aliyuncs.com/timeout.png)
- 22:29:13 - 提出s1带宽占满，要求升级带宽
- 情况有所好转，但是还是容易爆错
- 23:06:24 - 带宽升级后，访问量再次上升，突破qps50,pv达到20W
<br>![Alt text](http://enbrands-2.oss-cn-shanghai.aliyuncs.com/pv-2.png)
- 23:47:21 - 访问量下降，系统压力减少，页面响应速度慢慢恢复

2017 4 22
- 00:14 - QPS逐步下降，警报基本接触

本次故障，是由于会员段压力过大，导致enbrands数据请求来不及及时送出（带宽），而引起的连锁反应，在升级带宽后有所好转，QPS下降后警报接触。本次QPS最高逼近65，PV也暴增了25W（22:45分）。

# 本次故障，前端角度给出一下几个优化的建议
## 页面静态化，或缓存
首先我们先看一下页面的基本渲染步骤
<br>![Alt text](http://enbrands-2.oss-cn-shanghai.aliyuncs.com/render-process.png)
由于S1服务器不能及时将页面信息返回回来，导致会员端超时出现了5XX错误，会员端的页面以来主服务器是不科学的，应该将会员端的页面进行静态化处理或是缓存，保证及时在服务端高压的情况下，页面访问也能健步如飞，和服务端一点关系都没有。如果可以这部分让NODEJS介入加速（前端维护，包括预编译），会对移动端响应有很大的提升，当前业务下，可以先将缓存做好，并合理设置last-modified等信息。

## 错误码归类整理以及错误报告机制
目前，异步接口的错误码都是1，无法分辨出这是何种类型的错误，前端在错误甄别以及采集上面，无从判断，更别说从前端进行错误反馈了，当然后端进行反馈也可以，但是一定要做好错误码的分类工作，比如 大于100的错误吗，就是严重性错误，必须反馈

## 逐步形成各类型的运维监控程序与工具
自动化检测，页面响应速度，接口响应速度等，这些在日后的工作中要慢慢补齐。

上面的内容可能写的不是很全面，会员端的优化工作任重而道远。
